---
title: "Alevin Kallisto comparisons"
author: "Joshua Shapiro for CCDL"
output: 
  html_notebook:
    toc: true
    toc_float: true
---

This notebook contains analysis of some initial benchmarking in runs of Alevin and Kallisto

## Setup

### Load Libraries
```{r setup}
library(ggplot2)
library(magrittr)
library(SingleCellExperiment)
library(DropletUtils)
library(tximport)

# set seed
set.seed(2020)
```



### File and directory setup
```{r}
data_dir <- file.path("data", "quants")
dir.create(data_dir, recursive = TRUE, showWarnings = FALSE)

alevin_data_dir <- file.path(data_dir, "alevin")
dir.create(alevin_data_dir, recursive = TRUE, showWarnings = FALSE)
quant_s3_alevin <- "s3://nextflow-ccdl-results/scpca-benchmark/quants/alevin"

kallisto_data_dir <- file.path(data_dir, "kallisto")
dir.create(kallisto_data_dir, recursive = TRUE, showWarnings = FALSE)
quant_s3_kallisto <- "s3://nextflow-ccdl-results/scpca-benchmark/quants/kallisto"

```

### Sync S3 files

```{r}
sync_call <- paste("aws s3 sync", quant_s3_alevin, alevin_data_dir)
system(sync_call, ignore.stdout = TRUE)

# exclude bus files, which are large
sync_call <- paste("aws s3 sync", quant_s3_kallisto, kallisto_data_dir, 
                   '--exclude "*/bus/*"')
system(sync_call, ignore.stdout = TRUE)
```

Get the sample list and make a data frame with sample info

```{r}
quant_dirs <- list.dirs(c(alevin_data_dir, kallisto_data_dir),
                        full.names = FALSE, recursive = FALSE)


# split ids into components for later processing
quant_info <- data.frame (quant_dir = quant_dirs, info = quant_dirs) %>%
  tidyr::separate(info, sep = "[-]", 
                  into = c("sample", "index_type")) %>%
  tidyr::separate(index_type, 
                  into = c("tool", "index_content", "decoy"), 
                  extra = "drop")
  
```

### Get Annotations from AnnotationHub

```{r}
hub = AnnotationHub::AnnotationHub(ask = FALSE)
# Ensembl v100 Homo sapiens is AH79689
ensdb = hub[["AH79689"]]
ensg <- genes(ensdb)
```

Create vectors of mitochondrial genes and coding genes for later.

```{r}
# create the mitochondrial gene list
mito_genes <- ensg[seqnames(ensg) == 'MT']$gene_id

coding_genes <- ensg[ensg$gene_biotype == "protein_coding"]$gene_id
```



## Process quantification files


### Alevin

Use tximport to make SCEs

```{r}
alevin_quant_ids <- quant_info %>%
  dplyr::filter(tool == "alevin") %>%
  dplyr::pull(quant_dir)

alevin_sces <- alevin_quant_ids  %>%
  purrr::map(
    ~ tximport(file.path(alevin_data_dir, .x, "alevin", "quants_mat.gz"),
               type = "alevin")) %>%
  purrr::map(
    ~ SingleCellExperiment(list(counts = .x$counts))) 

# add names
names(alevin_sces) <- alevin_quant_ids
```

Calculate cell and feature QC statistics for each sample

```{r}
alevin_sces <- alevin_sces %>% 
  purrr::map(
    ~ scater::addPerCellQC(
      .x,
      subsets = list(mito = mito_genes[mito_genes %in% rownames(.x)])
    ) 
  ) %>%
  purrr::map(scater::addPerFeatureQC)
```

```{r}
alevin_cell_qc <- alevin_sces %>%
  purrr::map_df( ~ as.data.frame(colData(.x)) %>%
                   tibble::rownames_to_column(var = "cell_id"),
                 .id = "quant_id") %>%
  dplyr::left_join(quant_info, by = c("quant_id" = "quant_dir"))
```

```{r}
summary(alevin_cell_qc$sum)
```



### Kallisto


```{r}
kallisto_quant_ids <- quant_info %>%
  dplyr::filter(tool == "kallisto") %>%
  dplyr::pull(quant_dir)

base_file <- file.path(kallisto_data_dir, kallisto_quant_ids, "counts", "gene_count")
```

#### Function for reading Kallisto files

Takes a base file name and reads the the mtx file and associated barcode and gene files files.  
Filters to 
```{r}
read_kallisto_counts <- function(base, cellfilter = c("knee", "none")){
  cellfilter <- match.arg(cellfilter)
  counts <- Matrix::readMM(paste0(base,".mtx"))%>%
    t() %>% # transpose to gene x cell orientation
    as("dgCMatrix") # compress sparse matrix
  dimnames(counts) <- list(readLines(paste0(base,".", "genes.txt")),
                           readLines(paste0(base,".barcodes.txt")))
  if(cellfilter == "knee"){
    # calculate ranks and find knee
    rank_df <- DropletUtils::barcodeRanks(counts)
    cells <- which(rank_df$total >= metadata(rank_df)$knee)
    counts <- counts[, cells]
  }
  return(counts)
}
```


```{r}
kallisto_sces <- base_file %>%
  purrr::map(read_kallisto_counts) %>%
  purrr::map(
    ~ SingleCellExperiment(list(counts = .x))) 

# add names
names(kallisto_sces) <- kallisto_quant_ids
```


Calculate cell and feature QC statistics for each sample

```{r}
kallisto_sces <- kallisto_sces %>% 
  purrr::map(
    ~ scater::addPerCellQC(
      .x,
      subsets = list(mito = mito_genes[mito_genes %in% rownames(.x)])
    ) 
  ) %>%
  purrr::map(scater::addPerFeatureQC)
```

```{r}
kallisto_cell_qc <- kallisto_sces %>%
  purrr::map_df(~ as.data.frame(colData(.x)) %>%
                  tibble::rownames_to_column(var = "cell_id"),
                .id = "quant_id") %>%
  dplyr::left_join(quant_info, by = c("quant_id" = "quant_dir"))
```

```{r}
summary(kallisto_cell_qc$sum)
```
