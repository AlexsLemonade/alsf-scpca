---
title: "Analysis of Genes detected between Tools"
author: "Ally Hawkins for CCDL"
output: 
  html_notebook:
    toc: true
    toc_float: true
---

This is a quick comparison of the genes that are detected when using cellranger or when using alevin-fry. 
Here, we have alevin-fry that has been run in two different resolution modes, `cr-like` or `cr-like-em`. 

## Setup

```{r}
library(magrittr)
library(ggplot2)
library(ggupset)
library(SingleCellExperiment)
library(clusterProfiler)
library(org.Hs.eg.db)
```

```{r}
# path to results files with sces and qc dataframes from running benchrmarking_generate_qc_df.R
base_dir <- here::here()
file_dir <- file.path(base_dir, "data", "cr-like-test", "results")

# qc files 
rowdata_df_file <- file.path(file_dir, "rowdata_qc.tsv")
coldata_df_file <- file.path(file_dir, "coldata_qc.tsv")
quant_info_file <- file.path(file_dir, "quant_info.tsv")

# sce objects
cr_like_file <- file.path(file_dir, "splici_salign_cr-like_sces.rds")
cr_like_em_file <- file.path(file_dir, "splici_salign_cr-like-em_sces.rds")
cellranger_file <- file.path(file_dir, "cellranger_sces.rds")
```

```{r}
# read in rowdata_df containing information about each gene
rowdata_df <- readr::read_tsv(rowdata_df_file)
coldata_df <- readr::read_tsv(coldata_df_file)
quant_info <- readr::read_tsv(quant_info_file)
```

```{r}
# read in sces
cr_like_sce <- readr::read_rds(cr_like_file)
cr_like_em_sce <- readr::read_rds(cr_like_em_file)
cellranger_sce <- readr::read_rds(cellranger_file)
```


```{r}
# join coldata with quant_info 
alevin_fry_tools <- c("splici_salign_cr-like", "splici_salign_cr-like-em")
# merge coldata df with quant_info
coldata_info_df <- coldata_df %>%
  # rename tool to be either cellranger or alevin-fry
  dplyr::mutate(tool = ifelse(tool %in% alevin_fry_tools, "alevin-fry", "cellranger")) %>%
  dplyr::left_join(quant_info,
                   by = c("tool" = "tool", 
                          "quant_id" = "quant_dir")) %>%
  # rename the not_alevin to cellranger for plotting purposes
  dplyr::mutate(alevin_resolution = ifelse(alevin_resolution == "not_alevin", "cellranger", alevin_resolution))

# modify quant info to have alevin resolution as cellranger rather than not_alevin
quant_info <- quant_info %>%
  dplyr::mutate(alevin_resolution = ifelse(alevin_resolution == "not_alevin", "cellranger", alevin_resolution))
```


```{r}
# filter for common cells across all samples 
cell_counts <- coldata_info_df %>%  
  dplyr::count(cell_id, sample)

common_cells <- cell_counts %>%
  dplyr::filter(n == 3) %>%
  dplyr::pull(cell_id)
```

```{r}
# make a function to filter sces by subset of cells and re-calculate feature stats
filter_sce <- function(sce, cells){
  cells_to_keep <- colnames(sce) %in% cells
  SummarizedExperiment::rowData(sce) <- NULL
  sce[, cells_to_keep] %>%
    scater::addPerFeatureQC()
}
```


```{r}
# filter all sces together 
all_sces <- list(cr_like_sce,
                 cr_like_em_sce,
                 cellranger_sce)
names(all_sces) <- c('cr-like', 'cr-like-em', 'cellranger')

sces_filtered <- all_sces %>%
  purrr::map(
    ~ purrr::map(.x, filter_sce, cells = common_cells)
  )

# grab rowdata from filtered sces 
rowdata_filtered <- sces_filtered %>% 
  purrr::map_df(
    ~ purrr::map_df(.x, scpcaTools::rowdata_to_df, .id = "quant_dir"),
    .id = "alevin_resolution"
  ) %>%
  dplyr::left_join(quant_info)
```

## Differences in Gene detection between Alevin-fry and Cellranger

### Overlap of Genes 

As another comparison, let's look at the actual genes that are identified in each of the tools. 
Let's see how many are lost when we use alevin-fry over cellranger and what types of genes they are. 
Here, we will consider all genes that have the capability to be detected in alevin-fry and cellranger, regardless of if they are expressed or not. 


```{r}
# pull out genes that are detected and expressed in each of the tools
cellranger_genes <- rowdata_filtered %>%
  dplyr::filter(tool == "cellranger") %>%
  dplyr::pull(gene_id) %>%
  unique()

cr_like_genes <- rowdata_filtered %>%
  dplyr::filter(alevin_resolution == "cr-like") %>%
  dplyr::pull(gene_id) %>%
  unique()

cr_em_genes <- rowdata_filtered %>%
  dplyr::filter(alevin_resolution == "cr-like-em") %>%
  dplyr::pull(gene_id) %>%
  unique()
```


```{r}
# get intersection gene lists 
# look at intersection between cellranger and alevin-fry cr-like
cellranger_cr_intersect <- intersect(cellranger_genes, cr_like_genes)

# look at intersection between cellranger and alevin-fry cr-like-em
cellranger_cr_em_intersect <- intersect(cellranger_genes, cr_em_genes)

# look at intersection between alevin-fry cr-like and alevin-fry cr-like-em
cr_cr_em_intersect <- intersect(cr_like_genes, cr_em_genes)
```

```{r}
# get unique gene lists by getting genes that overlap with all other tools first and then the set difference with the list of genes for that tool
all_cellranger_overlap <- rowdata_filtered %>%
  dplyr::filter(gene_id %in% cellranger_genes & tool =="alevin-fry") %>%
  dplyr::pull(gene_id) %>%
  unique()
cellranger_unique <- setdiff(cellranger_genes, all_cellranger_overlap)

cr_overlap <- rowdata_filtered %>%
  dplyr::filter(gene_id %in% cr_like_genes & alevin_resolution %in% c("cr-like-em", "not_alevin")) %>%
  dplyr::pull(gene_id) %>%
  unique()
cr_unique <- setdiff(cr_like_genes, cr_overlap)

cr_em_overlap <- rowdata_filtered %>%
  dplyr::filter(gene_id %in% cr_em_genes & alevin_resolution %in% c("cr-like", "not_alevin")) %>%
  dplyr::pull(gene_id) %>%
  unique()
cr_em_unique <- setdiff(cr_em_genes, cr_em_overlap)
```


```{r}
# visualize overlap between gene sets based on tool

gene_detect_df <- rowdata_filtered %>%
  group_by(gene_id) %>%
  dplyr::summarise(tools_detected = list(unique(alevin_resolution)))

ggplot(gene_detect_df, aes(x = tools_detected)) +
  geom_bar() +
  scale_x_upset(n_intersections = 6)
```

When looking at shared cells only, we see that alevin-fry detects more genes than cellranger in both methods. 
Almost every gene that is found in cellranger is also being found in Alevin-fry so we are probably not losing much.

There are only 40 genes that cellranger can detect that alevin-fry cannot.

Perhaps the genes that are different are lowly expressed genes and it wouldn't matter anyway. 

If we now look at the gene expression for those genes that are unique to each tool, how do they compare to the gene expression for those genes that are shared?


```{r}
# calculate mean expression of log transformed counts matrix 
log_row_means <- function(sce){
   rowMeans(log1p(counts(sce))) %>%
    as.data.frame() %>%
    tibble::rownames_to_column("gene_id") %>%
    dplyr::rename("mean_log_expression" = ".")
}

# get list of row mean data frames 
mean_exp_list <- sces_filtered %>%
  purrr::map(
    ~ purrr::map(.x, log_row_means)
  )

# join together into larger data frame with quant_dir and alevin_resolution as unique ID's
mean_exp_df <- mean_exp_list %>%
  purrr::map_df(
    ~ purrr::map_df(.x, rbind, .id = "quant_dir"), 
    .id = "alevin_resolution"
  ) %>%
  dplyr::left_join(quant_info)

# join back with quant_info to get sample information 
```


Now, we want to classify each gene as being shared by all of the tools or unique. 
Because the alevin-fry tools are sharing the same index and therefore the same set of genes, we can say that genes are shared among all tools if they are found in an alevin-fry tool and cellranger. 
On the other hand, we are specifically interested in the difference between alevin-fry and cellranger and because we have no unique genes between `cr-like` and `cr-like-em`, we will look at genes that are not found in cellranger and call those unique. 
```{r}
# prove that cr-like-em and cr-like have the same gene list so the intersect between cellranger and these tools is the same
all.equal(cellranger_cr_em_intersect, cellranger_cr_intersect)

# add a column to classify as shared or unique to that tool
mean_exp_df <- mean_exp_df %>%
  dplyr::mutate(gene_status = ifelse(gene_id %in% c(cellranger_cr_intersect), "shared", "unique")) 
```


```{r fig.height = 5, fig.width=10}
# make a plot to look at the mean gene expression of shared vs. unique genes for each tool
ggplot(mean_exp_df, aes(x = alevin_resolution, y =mean_log_expression , fill = gene_status)) + 
  geom_boxplot() + 
  facet_wrap(~sample, nrow = 2) + 
  coord_cartesian(ylim = c(0,1))
```

As expected, across the board, it looks like the unique genes are those with lower mean gene expression than those genes that are shared across all tools. 
The genes that are lost are probably not contributing very much to downstream results. 

Let's look at the few unique genes in alevin-fry and cellranger that are higher expressed. 
 
```{r}
cellranger_unique_high <- mean_exp_df %>%
  dplyr::filter(alevin_resolution == "cellranger" & 
                  gene_status == "unique" & 
                  mean_log_expression > 0.25) %>%
  dplyr::pull(gene_id)

rowdata_filtered %>%
  dplyr::filter(gene_id %in% cellranger_unique_high)
```
 All of the points that are high in cellranger are from PRRC2B, or proline-rich coiled-coil 2B. 
 
```{r}
cr_like_em_unique_high <- mean_exp_df %>%
  dplyr::filter(alevin_resolution == "cr-like-em" & 
                  gene_status == "unique" & 
                  mean_log_expression > 0.50) %>%
  dplyr::pull(gene_id)

rowdata_filtered %>%
  dplyr::filter(gene_id %in% cr_like_em_unique_high) %>%
  dplyr::arrange(desc(mean))
```

These genes that are found in cr-like-em include the following: 

ENSG00000210082 - MT-RNR2
ENSG00000251562 - MALAT1
ENSG00000211459 - MT-RNR1

Two of the top three expressed genes identified in only alevin-fry are mitochondrial genes and the other is a long non-coding RNA that is commonly found expressed across tissues. 

### Gene Ontology

Let's make sure that we aren't losing any genes that we might care about and would be important pathways in pediatric oncology. 

First we need to identify the genes that are unique to each of the tools and would be lost if we weren't using that tool. 

```{r}
# join back with initial rowdata_df to get symbol to use for gene set enrichment analysis 
cellranger_rowdata <- rowdata_df %>%
  dplyr::filter(tool == "cellranger") %>%
  dplyr::select(gene_id, Symbol)

cellranger_lost <- rowdata_filtered %>%
  dplyr::filter(gene_id %in% cellranger_unique) %>%
  dplyr::left_join(cellranger_rowdata) %>%
  dplyr::arrange(desc(mean)) %>%
  dplyr::select(gene_id, mean, Symbol, detected, sample) %>%
  unique()

alevin_fry_rowdata <- rowdata_df %>%
  dplyr::filter(tool == "splici_salign_cr-like-em") %>%
  dplyr::select(gene_id, Symbol)

alevin_fry_lost <- rowdata_filtered %>%
  dplyr::filter(!(gene_id %in% cellranger_cr_em_intersect)) %>%
  dplyr::left_join(alevin_fry_rowdata) %>%
  dplyr::arrange(desc(mean)) %>%
  dplyr::select(tool, gene_id, Symbol, mean, detected, sample) %>%
  unique()

```

Since we are specifically interested in looking at what we would lose if we were to use alevin-fry over cellranger, let's focus on the genes lost in cellranger. 

```{r}
cellranger_lost
summary(cellranger_lost$mean)
summary(cellranger_lost$detected)
```


Notice that because we are looking at 4 different samples that have been run with cellranger, each gene is represented 4 times. 
It looks like for the most part they are lowly expressed other than the one gene, PRRC2B, but is found in the majority of cells.

These genes probably do not have an impact on downstream results if we are missing them, but let's be sure that we aren't missing out on any major pathways we would care about. 

Here, I am doing over representation analysis with the lost genes from not using cellranger as the target gene list and the background gene list being all genes identified in our tools. 

```{r}
cellranger_lost_gene_list <- cellranger_lost$Symbol %>%
  unique()
background_genes <- rowdata_df$Symbol %>%
  unique()
```

```{r}
# look to see what genes are found in cellranger and not found in alevin-fry
cellranger_lost_gene_list
```

```{r}
go_ora_results <- enrichGO(gene = cellranger_lost_gene_list,
                           universe = background_genes,
                           keyType = "SYMBOL",
                           OrgDb = org.Hs.eg.db,
                           ont = "BP",
                           pAdjustMethod = "BH",
                           pvalueCutoff = 0.00001)
```


```{r}
go_results <- go_ora_results@result %>%
  as.data.frame() %>%
  dplyr::filter(p.adjust < 0.00001)
go_results
```

It looks like we don't get enrichment of any particular pathway that is lost with the 40 genes not able to be detected in alevin-fry. 

What about the type of genes that are unique to alevin-fry. 

```{r}
alevin_fry_lost <- cr_em_lost$gene_id %>%
  unique()
background_genes <- rowdata_df$gene_id %>%
  unique()
```

```{r}
go_ora_results <- enrichGO(gene = alevin_fry_lost,
                           universe = background_genes,
                           keyType = "ENSEMBL",
                           OrgDb = org.Hs.eg.db,
                           ont = "BP",
                           pAdjustMethod = "BH",
                           pvalueCutoff = 0.00001)
```


```{r}
go_results <- go_ora_results@result %>%
  as.data.frame() %>%
  dplyr::filter(p.adjust < 0.00001)
go_results
```


```{r fig.width=5}
enrichplot::dotplot(go_ora_results)
```

Now if we look at the types of genes that are identified uniquely in Alevin-fry as opposed to Alevin we see a lot of immune related pathways and pathways related to micro RNA and non coding RNAs.

```{r}
sessioninfo::session_info()
```