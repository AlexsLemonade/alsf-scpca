---
title: "Analysis of Genes detected between Tools"
author: "Ally Hawkins for CCDL"
output: 
  html_notebook:
    toc: true
    toc_float: true
---

This is a quick comparison of the genes that are detected when using cellranger or when using alevin-fry. 
Here, we have alevin-fry that has been run in two different resolution modes, `cr-like` or `cr-like-em`. 

## Setup

```{r}
library(magrittr)
library(ggplot2)
library(eulerr)
library(clusterProfiler)
library(org.Hs.eg.db)
```

```{r}
# path to results files with sces and qc dataframes from running benchrmarking_generate_qc_df.R
base_dir <- here::here()
file_dir <- file.path(base_dir, "data", "cr-like-test", "results")

# qc files 
rowdata_df_file <- file.path(file_dir, "rowdata_qc.tsv")
```

```{r}
# read in rowdata_df containing information about each gene
rowdata_df <- readr::read_tsv(rowdata_df_file)
```

## Differences in Gene detection between Alevin-fry and Cellranger

### Overlap of Genes 

As another comparison, let's look at the actual genes that are identified in each of the tools. 
Let's see how many are lost when we use alevin-fry over cellranger and what types of genes they are. 

```{r}
# pull out genes that are detected and expressed in each of the tools
cellranger_genes <- rowdata_df %>%
  dplyr::filter(tool == "cellranger" & detected > 0 & mean > 0) %>%
  dplyr::pull(gene_id) %>%
  unique()

cr_like_genes <- rowdata_df %>%
  dplyr::filter(tool == "splici_salign_cr-like" & detected > 0 & mean > 0) %>%
  dplyr::pull(gene_id) %>%
  unique()

cr_em_genes <- rowdata_df %>%
  dplyr::filter(tool == "splici_salign_cr-like-em" & detected > 0 & mean > 0) %>%
  dplyr::pull(gene_id) %>%
  unique()
```

```{r}
# make sure rowdata only has genes that are found in more than 0% cells and > 0% mean gene expression
rowdata_df_filter <- rowdata_df %>%
  dplyr::filter(detected > 0 & mean > 0)
```


```{r}
# look at intersection between cellranger and alevin-fry cr-like
cellranger_cr_intersect <- rowdata_df_filter %>%
  dplyr::filter(gene_id %in% cr_like_genes & tool == "cellranger") %>%
  dplyr::pull(gene_id) %>%
  unique()

venn_prep <- c("Cellranger" = length(cellranger_genes) - length(cellranger_cr_intersect), 
               "cr-like" = length(cr_like_genes) - length(cellranger_cr_intersect), 
               "Cellranger&cr-like" = length(cellranger_cr_intersect))
plot(euler(venn_prep), quantities = TRUE)

```

```{r}
# look at intersection between cellranger and alevin-fry cr-like-em
cellranger_cr_em_intersect <- rowdata_df_filter %>%
  dplyr::filter(gene_id %in% cr_em_genes & tool == "cellranger") %>%
  dplyr::pull(gene_id) %>%
  unique()

venn_prep <- c("Cellranger" = length(cellranger_genes) - length(cellranger_cr_em_intersect), 
               "cr-like-em" = length(cr_em_genes) - length(cellranger_cr_em_intersect), 
               "Cellranger&cr-like-em" = length(cellranger_cr_em_intersect))
plot(euler(venn_prep), quantities = TRUE)

```

```{r}
# look at intersection between alevin-fry cr-like and alevin-fry cr-like-em
cr_cr_em_intersect <- rowdata_df_filter %>%
  dplyr::filter(gene_id %in% cr_em_genes & tool == "splici_salign_cr-like") %>%
  dplyr::pull(gene_id) %>%
  unique()

venn_prep <- c("cr-like" = length(cr_like_genes) - length(cr_cr_em_intersect), 
               "cr-like-em" = length(cr_em_genes) - length(cr_cr_em_intersect), 
               "cr-like&cr-like-em" = length(cr_cr_em_intersect))
plot(euler(venn_prep), quantities = TRUE)
```

Here we can see that Alevin-fry in general detects more genes than cellranger but probably with lower counts as we saw when looking at all cells vs. shared cells above. 
It looks like the majority of the genes are shared in all of the tools, but of the ones that aren't shared are they ones that we would miss out if we chose alevin-fry over cellranger?

Perhaps they are lowly expressed genes and it wouldn't matter anyway. 

If we now look at the gene expression for those genes that are unique to each tool, how do they compare to the gene expression for those genes that are shared?

```{r}
# add a column in colData to classify as shared or unique to that tool
rowdata_df_filter <- rowdata_df_filter %>%
  dplyr::mutate(gene_status = ifelse(gene_id %in% c(cellranger_cr_intersect, cellranger_cr_em_intersect, cr_cr_em_intersect), "shared", "unique")) 
```


```{r}
# make a plot to look at the mean gene expression of shared vs. unique genes for each tool
ggplot(rowdata_df_filter, aes(x = tool, y = mean, fill = gene_status)) + 
  geom_boxplot() + 
  ylim(c(0,2))
```

As expected, across the board, it looks like the unique genes are those with lower mean gene expression than those genes that are shared across other tools. 
The genes that are lost are probably not contributing very much to downstream results. 
 

### Gene Ontology

Let's make sure that we aren't losing any genes that we might care about and would be important pathways in pediatric oncology. 

First we need to identify the genes that are unique to each of the tools and would be lost if we weren't using that tool. 

```{r}
cellranger_lost <- rowdata_df_filter %>%
  dplyr::filter(gene_status == "unique" & tool == "cellranger") %>%
  dplyr::arrange(desc(mean)) %>%
  dplyr::select(gene_id, Symbol, mean, detected)

cr_like_lost <- rowdata_df_filter %>%
  dplyr::filter(gene_status == "unique" & tool == "splici_salign_cr-like") %>%
  dplyr::arrange(desc(mean)) %>%
  dplyr::select(gene_id, Symbol, mean, detected)

cr_em_lost <- rowdata_df_filter %>%
  dplyr::filter(gene_status == "unique" & tool == "splici_salign_cr-like-em") %>%
  dplyr::arrange(desc(mean)) %>%
  dplyr::select(tool, gene_id, Symbol, mean, detected)

```

Since we are specifically interested in looking at what we would lose if we were to use alevin-fry over cellranger, let's focus on the genes lost in cellranger. 

```{r}
head(cellranger_lost)
summary(cellranger_lost$mean)
summary(cellranger_lost$detected)
```

Notice that because we are looking at 4 different samples that have been run with cellranger, each gene is represented 4 times. 
It looks like for the most part they are lowly expressed other than the one gene that still has low expression but is found in the majority of cells, PRRC2B.

These genes probably do not have an impact on downstream results if we are missing them, but let's be sure that we aren't missing out on any major pathways we would care about. 

Here, I am doing over representation analysis with the lost genes from not using cellranger as the target gene list and the background gene list being all genes identified in our tools. 

```{r}
cellranger_lost_gene_list <- cellranger_lost$Symbol %>%
  unique()
background_genes <- rowdata_df$Symbol %>%
  unique()
```

```{r}
# look to see what genes are found in cellranger and not found in alevin-fry
cellranger_lost_gene_list
```

```{r}
go_ora_results <- enrichGO(gene = cellranger_lost_gene_list,
                           universe = background_genes,
                           keyType = "SYMBOL",
                           OrgDb = org.Hs.eg.db,
                           ont = "BP",
                           pAdjustMethod = "BH",
                           pvalueCutoff = 0.00001)
```


```{r}
go_results <- go_ora_results@result %>%
  as.data.frame() %>%
  dplyr::filter(p.adjust < 0.00001)
```


```{r fig.width=5}
enrichplot::dotplot(go_ora_results)
```

It looks like we are getting all the same variation of a similar pathway with 32 genes that are found to be involved in sensory perception. 

For context, the samples used in benchmarking are two neuroblastoma samples and two wilms tumor samples. 
There is some evidence of genes involved in sensory perception being involved in neuroblastoma, but generally these genes have very low expression and are detected in a small percentage of cells. 

I think there is still strong support for use of alevin-fry with the `cr-like-em` resolution. 

```{r}
sessioninfo::session_info()
```