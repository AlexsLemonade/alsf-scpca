---
title: "R Notebook"
output: html_notebook
---


```{r}
library(magrittr)
library(SingleCellExperiment)
library(DropletUtils)
library(tximport)
library(Matrix.utils)
library(scater)
```

```{r}
# load any functions we will need that aren't part of scpcaTools
function_path <- file.path(".." ,"benchmarking-functions", "R")
source(file.path(function_path, "aws_copy_samples.R"))
source(file.path(function_path, "quant_info_table.R"))
source(file.path(function_path, "add_sce_QC.R"))
```

```{r}
base_dir <- here::here()
data_dir <- file.path(base_dir, 'data', 'quants')

output_dir <- file.path(base_dir, "results")
if(!dir.exists(output_dir)){
  dir.create(output_dir, recursive = TRUE)
}
```


## Copy from AWS 

```{r}

quant_s3 <- 's3://nextflow-ccdl-results/scpca'

samples <- c('SCPCR000006', 'SCPCR000118', 'SCPCR000119', 
             'SCPCR000126', 'SCPCR000127', 'SCPCR000220',
             'SCPCR000221')

aws_copy_samples(local_dir = data_dir,
                 s3_dir = quant_s3,
                 samples = samples,
                 tools = c('alevin-fry-unfiltered', 'cellranger'))
```


```{r}
# get library data to add cell or nucleus information for each sample
library_data_dir <- file.path(base_dir, 'sample-info')
dir.create(library_data_dir, recursive = TRUE, showWarnings = FALSE)
sample_info_dir_s3 <- 's3://ccdl-scpca-data/sample_info'

# grab library metadata from location in s3
sync_call <- paste('aws s3 sync', sample_info_dir_s3, library_data_dir,
                   '--exclude "*"', 
                   '--include "*scpca-library-metadata.tsv"')
system(sync_call, ignore.stdout = TRUE)

## get mitochondrial gene list from s3
annotation_files_s3 <- 
  's3://nextflow-ccdl-data/reference/homo_sapiens/ensembl-103/annotation/'

sync_call <- paste('aws s3 sync', annotation_files_s3, library_data_dir,
                   '--exclude "*"', 
                   '--include "*103.mitogenes.txt"')
system(sync_call, ignore.stdout = TRUE)
```


## Make SingleCellExperiment objects 

```{r}
# generate quant info table
quant_info <- quant_info_table(data_dir = data_dir,
                 tools = c('alevin-fry-unfiltered', 'cellranger'),
                 samples = samples)
```


```{r}
# read in sample metadata
library_df <- readr::read_tsv(file.path(library_data_dir, "scpca-library-metadata.tsv"))
select_metadata_df <- library_df %>%
  dplyr::select(scpca_run_id, seq_unit)

quant_info <- quant_info %>% 
  dplyr::left_join(select_metadata_df, by = c("sample" = "scpca_run_id")) %>%
  dplyr::mutate(which_counts = dplyr::case_when(seq_unit == "cell" ~ "spliced",
                                                seq_unit == "nucleus" ~ "unspliced"))
```


```{r}
mito_file <- file.path(library_data_dir, "Homo_sapiens.GRCh38.103.mitogenes.txt")

mito_genes <- readr::read_tsv(mito_file, col_names = "gene_id")
mito_genes <- mito_genes %>%
  dplyr::pull(gene_id)
```

Because the list of `SingleCellExperiments` would be quite large for Alevin-fry, I'm going to go ahead and make separate lists now for each of the conditions that was used. 

For benchmarking we have tested the following conditions:

- spliced (cDNA) txome, salign, cr-like
- spliced (cDNA) txome, sketch, cr-like
- unspliced (splici) txome, salign, full
- unspliced (splici) txome, sketch, full
- unspliced (splici) txome, salign, cr-like
- unspliced (splici) txome, sketch, cr-like

```{r}
# make separate tables based on conditions above 
cdna_salign_full <- quant_info %>%
  dplyr::filter(tool == "alevin_fry" &
                index_type == "cDNA" &
                alevin_alignment == "sketch" &
                alevin_resolution == "full")

alevin_info <- quant_info %>%
  dplyr::filter(tool == "alevin-fry") %>%
  dplyr::mutate(group_name = paste(index_type, alevin_alignment, alevin_resolution, sep = "_")) %>%
  dplyr::arrange(group_name) 

alevin_split_info <- alevin_info %>%
  dplyr::group_split(group_name)

names(alevin_split_info) <- alevin_info %>%
  dplyr::pull(group_name) %>%
  unique()

list2env(alevin_split_info, .GlobalEnv)
```


```{r, message=FALSE}
make_sce_list <- function(info_df, filename, mito){
  sce_list <- mapply(scpcaTools::import_quant_data,
         info_df$data_dir,
         info_df$tool,
         info_df$which_counts,
         info_df$intron_mode,
         info_df$usa_mode,
         info_df$filter) 
    sce_list <- sce_list %>%
      purrr::map(
      ~ scater::addPerCellQC(.x,
                       subsets = list(mito_genes = mito_genes[mito_genes %in% rownames(.x)]))
      ) %>%
      purrr::map(
        ~ scater::addPerFeatureQC(.x)
      )
  readr::write_rds(sce_list, filename)
  return(sce_list)
}
```


```{r, message=FALSE}
# get alevin_fry_sces
cDNA_salign_cr_sces <- make_sce_list(cDNA_salign_cr,
                                     filename = file.path(output_dir, 
                                                          "alevin_fry_cDNA_salign_cr_sces.rds"))
cDNA_sketch_cr_sces <- make_sce_list(cDNA_sketch_cr, 
                                     filename = file.path(output_dir, 
                                                          "alevin_fry_cDNA_sketch_cr_sces.rds"))
splici_salign_full_sces <- make_sce_list(splici_salign_full, 
                                         filename = file.path(output_dir, 
                                                          "alevin_fry_splici_full_cr_sces.rds"))
splici_sketch_full_sces <- make_sce_list(splici_sketch_full,
                                         filename = file.path(output_dir, 
                                                          "alevin_fry_splici_sketch_full_sces.rds"))
splici_salign_cr_sces <- make_sce_list(splici_salign_cr, 
                                       filename = file.path(output_dir, 
                                                          "alevin_fry_splici_salign_cr_sces.rds"))
splici_sketch_cr_sces <- make_sce_list(splici_sketch_cr, 
                                       filename = file.path(output_dir, 
                                                          "alevin_fry_splici_sketch_cr_sces.rds"))
```


```{r}
# get cellranger sces 
cellranger_info <- quant_info %>%
  dplyr::filter(tool == "cellranger")

cellranger_fry_sces <- make_sce_list(cellranger_info, 
                                     filename = file.path(output_dir,
                                                          "cellranger_sces.rds"))
```

```{r}

```

