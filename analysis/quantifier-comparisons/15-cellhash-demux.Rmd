---
title: "Genetic demultiplexing vs. cellhash"
author: "Josh Shapiro for CCDL"
output: 
  html_notebook:
    toc: true
    toc_float: true
params:
  lib_id: "SCPCL000535"
---

# Set Up
 
Libraries:

```{r setup}
suppressPackageStartupMessages({
  library(ggplot2)
  library(SingleCellExperiment)
  library(Seurat)
})

theme_set(theme_bw())
```

File paths:

```{r}
file_dir <- file.path("data", "cellhash")

# singleCellExperiment file
unfiltered_file <- file.path(file_dir, paste0(params$lib_id, "_unfiltered.rds"))
# Vireo output
vireo_file <- file.path(file_dir, paste0(params$lib_id, "_vireo"), "donor_ids.tsv") 

# file with sample and barcode info for all samples
pool_file <- file.path(file_dir, "christensen-pools.tsv")
```

# Single cell processing and filtering

## Filtering with emptyDropsCellRanger

```{r}
sce_unfiltered <- readRDS(unfiltered_file)
sce <- scpcaTools::filter_counts(sce_unfiltered)
```

```{r}
# recalculate feature stats
sce <- scater::addPerFeatureQC(sce)
altExp(sce) <- scater::addPerFeatureQC(altExp(sce))
```

## Adding cellhash sample info

Read in the pool data & filter to this experiment.
```{r}
pool_info <- readr::read_tsv(pool_file) |>
  dplyr::filter(scpca_library_id == params$lib_id)
```

Merge sample info with stats & look.
```{r}
hash_data <- rowData(altExp(sce, "cellhash")) |>
  as.data.frame() |>
  tibble::rownames_to_column("HTO") |> 
  dplyr::left_join(pool_info, by = c("HTO" = "barcode_id"))
hash_data
```

Filter cellhash counts to only intended samples.
```{r}
altExp(sce, "cellhash") <- altExp(sce, "cellhash")[!is.na(hash_data$scpca_sample_id),]
rownames(altExp(sce, "cellhash")) <- hash_data$scpca_sample_id[!is.na(hash_data$scpca_sample_id)]
```

# Cell Hashing results

## DropletUtils

Demux identities with `DropletUtils::hashedDrops()`
```{r}
hash_result <- DropletUtils::hashedDrops(altExp(sce, "cellhash"))

# save results for later
hashdrops_demux <- data.frame(
  cell_barcode = rownames(hash_result),
  hashdrops_maxid = rownames(altExp(sce, "cellhash"))[hash_result$Best],
  hashdrops_logfc = hash_result$LogFC,
  hashdrops_confident = hash_result$Confident
) |>
  dplyr::mutate(hashdrops_id = ifelse(hashdrops_confident, hashdrops_maxid, NA_character_))
```

Confident demux table:
```{r}
table(hashdrops_demux$hashdrops_id)
```

## Seurat

First convert to a seurat object & normalize, then demux with `Seurat::HTODemux()`

```{r}
# create a Seurat object
seurat_obj <- Seurat::CreateSeuratObject(counts(sce))
seurat_obj[["HTO"]] <- CreateAssayObject(counts = counts(altExp(sce, "cellhash")))
seurat_obj <- Seurat::NormalizeData(seurat_obj, assay = "HTO", normalization.method = "CLR")
seurat_obj <- Seurat::HTODemux(seurat_obj)
```

Convert results to a data frame.
```{r}
seurat_demux <- data.frame(
  cell_barcode = colnames(seurat_obj),
  seurat_hashid = as.character(seurat_obj$hash.ID),
  seurat_maxid = as.character(seurat_obj$HTO_maxID),
  seurat_margin = seurat_obj$HTO_margin
) |>
  dplyr::mutate(seurat_id = ifelse(seurat_hashid %in% c("Doublet","Negative"), 
                                   NA_character_, 
                                   seurat_hashid))
```

Seurat demux table:
```{r}
table(seurat_demux$seurat_id)
```

# Genetic demultiplexing

We performed genetic demultiplexing with [cellsnp](https://cellsnp-lite.readthedocs.io/en/latest/) and [Vireo](https://vireosnp.readthedocs.io/en/latest/).

```{r}
# read in results
vireo_demux <- readr::read_tsv(vireo_file)|>
  dplyr::select(cell_barcode = cell,
                vireo_donorid = donor_id,
                vireo_maxid = best_singlet,
                vireo_probmax = prob_max,
                vireo_nvars = n_vars) |>
  dplyr::mutate(vireo_id = ifelse(vireo_donorid %in% c("doublet","unassigned"), 
                                  NA_character_, 
                                  vireo_donorid))
```
Genetic demux table:

```{r}
table(vireo_demux$vireo_id)
```


## Compare classifications

```{r}
# Start with all barcodes in sce 
demux <- data.frame(cell_barcode = colnames(sce)) |>
  dplyr::left_join(hashdrops_demux) |>
  dplyr::left_join(seurat_demux) |>
  dplyr::left_join(vireo_demux)
```

```{r}
table(demux$seurat_id, demux$vireo_id, useNA = "always", dnn = c("Seurat", "Vireo"))
```

```{r}
table(demux$hashdrops_id, demux$vireo_id, useNA = "always", dnn = c("Hashdrops", "Vireo"))
```


# Session info
```{r}
sessioninfo::session_info()
```
